#!/bin/sh
set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RESET='\033[0m'
PYTHON=.venv/bin/python3
REMOTE_VERSION=$(git show origin/main:package.json | jq -r '.version')
CURRENT_VERSION=$(jq -r '.version' package.json)

echo "üê∂ Husky: running pre-push hook..."

#echo ""
#make test-unit

# Get list of Python files that are actually committed and being pushed
COMMITTED_PY_FILES=$(git diff-tree --no-commit-id --name-only -r HEAD | grep '\.py$' || true)

if [ -n "$COMMITTED_PY_FILES" ]; then
  echo ""
  echo "üîç Checking formatting with black on committed files..."
  echo "$COMMITTED_PY_FILES" | xargs $PYTHON -m black --check || { echo "${RED}‚ùå Code is not properly formatted with black. Run: black <files>${RESET}"; exit 1; }

  echo ""
  echo "üîç Checking import sorting with isort on committed files..."
  echo "$COMMITTED_PY_FILES" | xargs $PYTHON -m isort --check-only || { echo "${RED}‚ùå Imports are not properly ordered. Run: isort <files>${RESET}"; exit 1; }

  echo ""
  echo "üîç Running flake8 (critical errors) on committed files..."
  echo "$COMMITTED_PY_FILES" | xargs $PYTHON -m flake8 --count --select=E9,F63,F7,F82 --show-source --statistics

  echo ""
  echo "üîç Running flake8 (complexity and style) on committed files..."
  echo "$COMMITTED_PY_FILES" | xargs $PYTHON -m flake8 --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

  echo ""
  echo "üîç Running mypy (static typing) on committed files..."
  echo "$COMMITTED_PY_FILES" | xargs $PYTHON -m mypy --config-file mypy.ini || { echo "‚ùå Typing errors detected!"; exit 1; }
else
  echo "üìù No Python files to check in this push"
fi

if [ -n "$COMMITTED_PY_FILES" ]; then
  echo ""
  echo "üîç Running bandit (security analysis) on committed files..."
  echo "$COMMITTED_PY_FILES" | xargs $PYTHON -m bandit -ll --ini .bandit || true

  echo ""
  echo "üîç Checking docstrings with pydocstyle on committed files..."
  echo "$COMMITTED_PY_FILES" | xargs $PYTHON -m pydocstyle || true

  echo ""
  echo "üîç Running pylint (code quality) on committed files..."
  echo "$COMMITTED_PY_FILES" | xargs $PYTHON -m pylint --rcfile=.pylintrc || true
fi

echo ""
echo "üîß Checking package.json version alignment..."
REMOTE_VERSION=$(git show origin/main:package.json | jq -r '.version')

echo "Current version: ${YELLOW}$CURRENT_VERSION${RESET}"
echo "Remote version: ${YELLOW}$REMOTE_VERSION${RESET}"
if [ "$CURRENT_VERSION" = "$REMOTE_VERSION" ]; then
  echo "‚ùå The version has not changed compared to origin/main!"
  echo "üí° Please update the version before pushing."
  exit 1
fi

echo ""
echo "${GREEN}üöÄ All set for push! Continuing...${RESET}"
