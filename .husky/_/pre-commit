#!/usr/bin/env sh
#!/bin/sh
set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
RESET='\033[0m'
PYTHON=.venv/bin/python3

echo "ğŸ” Husky: running pre-commit hook..."

# Get list of staged Python files
STAGED_PY_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.py$' || true)

if [ -n "$STAGED_PY_FILES" ]; then
  echo ""
  echo "ğŸ” Checking formatting with black (check mode) on staged files..."
  echo "$STAGED_PY_FILES" | xargs $PYTHON -m black --check || {
    echo "${RED}âŒ Code is not properly formatted with black.${RESET}"
    echo "   ğŸ‘‰ Run: black <files>"
    exit 1
  }

  echo ""
  echo "ğŸ” Checking import sorting with isort on staged files..."
  echo "$STAGED_PY_FILES" | xargs $PYTHON -m isort --check-only || {
    echo "${RED}âŒ Imports are not properly ordered.${RESET}"
    echo "   ğŸ‘‰ Run: isort <files>"
    exit 1
  }

  echo ""
  echo "ğŸ” Running flake8 for critical errors on staged files..."
  echo "$STAGED_PY_FILES" | xargs $PYTHON -m flake8 --count --select=E9,F63,F7,F82 --show-source --statistics || {
    echo "${RED}âŒ flake8 found critical errors.${RESET}"
    exit 1
  }
else
  echo "ğŸ“ No Python files to check in this commit"
fi

echo ""
echo "${GREEN}âœ… pre-commit completed successfully!${RESET}"
