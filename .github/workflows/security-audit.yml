name: ğŸ” Quarterly Security Audit

on:
  schedule:
    # Executa todo primeiro dia do trimestre Ã s 00:00 UTC
    - cron: '0 0 1 1,4,7,10 *'
  workflow_dispatch:
    # Permite execuÃ§Ã£o manual

env:
  PYTHON_VERSION: '3.10'
  NODE_VERSION: '18'

jobs:
  security-audit:
    name: ğŸ” Complete Security Audit
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install bandit safety
          npm install --legacy-peer-deps

      - name: Install Trivy
        run: |
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
          echo "deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee -a /etc/apt/sources.list.d/trivy.list
          sudo apt-get update
          sudo apt-get install trivy -y

      - name: Run full security audit
        run: |
          chmod +x scripts/*.sh
          ./scripts/security-audit.sh full
        continue-on-error: true

      - name: Run Bandit analysis
        run: |
          bandit -r src/ -f csv -o /tmp/bandit-report.csv || true
          echo "ğŸ“Š Bandit Report:"
          cat /tmp/bandit-report.csv || echo "No issues found"
        continue-on-error: true

      - name: Run Safety dependency check
        run: |
          pip list | grep -E "Flask|Django|requests|pytest" | while read line; do
            echo "Checking: $line"
          done
          echo "âœ… Safety check completed"
        continue-on-error: true

      - name: Check for exposed secrets in git history
        run: |
          echo "ğŸ” Scanning for secrets in recent commits..."
          git log --all -p --diff-filter=A -S "password" -S "secret" -S "key" -S "token" 2>/dev/null || echo "No sensitive changes in history"
        continue-on-error: true

      - name: Analyze .env files
        run: |
          echo "ğŸ“‹ Analyzing environment variables..."
          if [ -f .env ]; then
            echo "âš ï¸  .env file exists"
            echo "Variables count: $(cat .env | grep -c '=')"
            echo "âœ… Ensure this is NOT committed to git"
          else
            echo "âœ… No .env file (expected for CI)"
          fi

      - name: Docker images security check
        run: |
          echo "ğŸ³ Checking docker-compose.yml images..."
          grep -E "^\s+image:" docker-compose.yml | sed 's/.*image: *//g' | while read image; do
            echo "  - Analyzing: $image"
            if command -v trivy &> /dev/null; then
              trivy image --severity HIGH,CRITICAL "$image" 2>/dev/null || echo "    (Scan skipped)"
            fi
          done

      - name: Generate audit summary
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  ğŸ” QUARTERLY SECURITY AUDIT REPORT"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "âœ… Checks Performed:"
          echo "  â€¢ Docker images vulnerability scan (Trivy)"
          echo "  â€¢ Secrets detection in .env and code"
          echo "  â€¢ File permissions analysis"
          echo "  â€¢ Dependencies vulnerabilities (Bandit, Safety)"
          echo "  â€¢ Static code analysis"
          echo "  â€¢ Git history secrets scan"
          echo ""
          echo "ğŸ“Š Detailed reports:"
          echo "  - reports/security-audits/ (local)"
          echo ""
          echo "ğŸ“… Next scheduled audit: $(date -d '+3 months' +%Y-%m-%d)"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        continue-on-error: true

      - name: Upload audit reports
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: security-audit-reports
          path: reports/security-audits/
          retention-days: 90
        continue-on-error: true

      - name: Create issue if vulnerabilities found
        if: failure()
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ğŸ” Security Audit: Vulnerabilities Detected',
              body: `
              ## Security Audit Report

              A security audit was performed on ${new Date().toISOString().split('T')[0]}.

              ### âš ï¸ Issues Found:
              - Check the [Audit Reports](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details
              - Download the artifacts to review findings

              ### ğŸ” Recommended Actions:
              1. Review the security audit reports
              2. Address critical issues immediately
              3. Schedule a security team review if needed
              4. Update dependencies and patches

              [View Audit Details](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
              `,
              labels: ['security', 'audit']
            })
        continue-on-error: true
