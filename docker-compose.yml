# -------------------------------------------
# ğŸ³ Infraestrutura Base - Docker Compose
# ğŸ§‘â€ğŸ’» Autor: Kleilson Santos
# ğŸ“… Atualizado em: 2025-05-11
# ğŸ”§ ServiÃ§os:
#    - ğŸ“ˆ Monitoramento: Prometheus, Node Exporter, cAdvisor, MongoDB Exporter, PostgreSQL Exporter
#    - ğŸ§¹ Qualidade de CÃ³digo: SonarQube, ESLint, Prettier, Dependency Check
#    - ğŸ³ Containers: MongoDB, PostgreSQL, Redis, Portainer
# -------------------------------------------


services:
  portainer:
    image: portainer/portainer-ce # ğŸ“¦ Portainer image
    container_name: infra-default-portainer # ğŸ·ï¸ Container name
    env_file: .env # ğŸ“¦ Environment file
    restart: always # ğŸ” Automatically restarts if it stops
    ports:
      - "9001:9000" # ğŸŒ Port mapping
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock # ğŸ’¾ Volume for Docker socket
    networks:
      - infra-default-shared-net # ğŸŒ Network name
  sonarqube:
    image: sonarqube:latest # ğŸ“¦ SonarQube image
    container_name: infra-default-sonarqube # ğŸ·ï¸ Container name
    env_file: .env # ğŸ“¦ Environment file
    restart: always # ğŸ” Automatically restarts if it stops
    ports:
      - "9000:9000" # ğŸŒ Port mapping
    environment:
      SONAR_JDBC_URL: ${SONAR_JDBC_URL} # ğŸ˜ PostgreSQL connection URL
      SONAR_JDBC_USERNAME: ${SONAR_JDBC_USERNAME} # ğŸ‘¤ Database username
      SONAR_JDBC_PASSWORD: ${SONAR_JDBC_PASSWORD} # ğŸ”‘ Database password
      SONARQUBE_JVM_OPTIONS: ${SONARQUBE_JVM_OPTIONS} # ğŸ“Š JVM memory configuration
      SONAR_ES_BOOTSTRAP_CHECKS_DISABLE: ${SONAR_ES_BOOTSTRAP_CHECKS_DISABLE} # ğŸ”‘ Disable ES bootstrap checks
    volumes:
      - infra-default-sonarqube_data:/opt/sonarqube/data # ğŸ’¾ Volume for SonarQube data
      - infra-default-sonarqube_extensions:/opt/sonarqube/extensions # ğŸ’¾ Volume for SonarQube extensions
      - infra-default-sonarqube_logs:/opt/sonarqube/logs # ğŸ’¾ Volume for SonarQube logs
    networks:
      - infra-default-shared-net # ğŸŒ Network name

  mongo:
    image: mongo:latest # ğŸ“¦ MongoDB image
    container_name: infra-default-mongo # ğŸ·ï¸ Container name
    env_file: .env # ğŸ“¦ Environment file
    restart: always # ğŸ” Automatically restarts if it stops
    ports:
      - "27017:27017" # ğŸŒ Port mapping
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_INITDB_ROOT_USERNAME} # ğŸ”‘ MongoDB root username
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_INITDB_ROOT_PASSWORD} # ğŸ”‘ MongoDB root password
    volumes:
      - infra-default-mongo_data:/data/db # ğŸ’¾ Volume for MongoDB data
    networks:
      - infra-default-shared-net # ğŸŒ Network name

  mongo-express:
    image: mongo-express:1.0.0-alpha.4 # ğŸ“¦ Mongo Express image
    container_name: infra-default-mongo-express # ğŸ·ï¸ Container name
    env_file: .env # ğŸ“¦ Environment file
    restart: always # ğŸ” Automatically restarts if it stops
    ports:
      - "8081:8081" # ğŸŒ Port mapping
    environment:
      ME_CONFIG_MONGODB_SERVER: ${ME_CONFIG_MONGODB_SERVER} # ğŸ”‘ MongoDB server
      ME_CONFIG_MONGODB_PORT: ${ME_CONFIG_MONGODB_PORT} # ğŸ”‘ MongoDB port
      ME_CONFIG_MONGODB_ADMINUSERNAME: ${MONGO_INITDB_ROOT_USERNAME} # ğŸ”‘ MongoDB admin username
      ME_CONFIG_MONGODB_ADMINPASSWORD: ${MONGO_INITDB_ROOT_PASSWORD} # ğŸ”‘ MongoDB admin password
      ME_CONFIG_MONGODB_AUTH_DATABASE: ${ME_CONFIG_MONGODB_AUTH_DATABASE} # ğŸ”‘ MongoDB auth database
      ME_CONFIG_BASICAUTH_USERNAME: ${ME_CONFIG_BASICAUTH_USERNAME} # ğŸ”‘ Basic auth username
      ME_CONFIG_BASICAUTH_PASSWORD: ${ME_CONFIG_BASICAUTH_PASSWORD} # ğŸ”‘ Basic auth password
      ME_CONFIG_MONGODB_ENABLE_ADMIN: ${ME_CONFIG_MONGODB_ENABLE_ADMIN} # ğŸ”‘ Enable admin access
      ME_CONFIG_MONGODB_USE_UNIFIED_TOPOLOGY: ${ME_CONFIG_MONGODB_USE_UNIFIED_TOPOLOGY} # ğŸ”‘ Use unified topology
    depends_on:
      - mongo # ğŸ”„ Depends on MongoDB service
    networks:
      - infra-default-shared-net # ğŸŒ Network name
  postgres:
    image: postgres:15 # ğŸ“¦ PostgreSQL image
    container_name: infra-default-postgres # ğŸ·ï¸ Container name
    env_file: .env # ğŸ“¦ Environment file
    restart: always # ğŸ” Automatically restarts if it stops
    ports:
      - "5432:5432" # ğŸŒ Port mapping
    environment:
      POSTGRES_DB: ${POSTGRES_DB} # ğŸ”‘ PostgreSQL credentials
      POSTGRES_USER: ${POSTGRES_USER} # ğŸ”‘ PostgreSQL credentials
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD} # ğŸ”‘ PostgreSQL credentials
    volumes:
      - infra-default-postgres_data:/var/lib/postgresql/data # ğŸ’¾ Volume for PostgreSQL data
    networks:
      - infra-default-shared-net # ğŸŒ Network name

  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: infra-default-pgadmin # ğŸ·ï¸ Container name
    env_file: .env # ğŸ“¦ Environment file
    restart: always # ğŸ” Automatically restarts if it stops
    ports:
      - "8088:80" # ğŸŒ Port mapping
    depends_on:
      - postgres # ğŸ”„ Depends on PostgreSQL service
    environment:
      PGADMIN_DEFAULT_EMAIL: ${PGADMIN_DEFAULT_EMAIL} # ğŸ”‘ pgAdmin default email
      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_DEFAULT_PASSWORD} # ğŸ”‘ pgAdmin default email and password
    volumes:
      - infra-default-pgadmin-data:/var/lib/pgadmin # ğŸ’¾ Volume for data persistence
    networks:
      - infra-default-shared-net # ğŸŒ Network name

  mysql:
    image: mysql:5.7 # ğŸ“¦ MySQL image
    container_name: infra-default-mysql # ğŸ·ï¸ Container name
    env_file: .env # ğŸ“¦ Environment file
    restart: always # ğŸ” Automatically restarts if it stops
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD} # ğŸ”‘ Root password
      MYSQL_DATABASE: ${MYSQL_DATABASE} # ğŸ“‚ Default DB
      MYSQL_USER: ${MYSQL_USER} # ğŸ‘¤ App user
      MYSQL_PASSWORD: ${MYSQL_PASSWORD} # ğŸ” App password
    ports:
      - "3306:3306" # ğŸŒ Port mapping
    volumes:
      - infra-default-mysql_data:/var/lib/mysql # ğŸ’¾ Volume for MySQL data
    networks:
      - infra-default-shared-net # ğŸŒ Network name

  phpmyadmin:
    image: phpmyadmin/phpmyadmin:latest # ğŸ“¦ phpMyAdmin image
    container_name: infra-default-phpmyadmin # ğŸ·ï¸ Container name
    env_file: .env # ğŸ“¦ Environment file
    restart: always # ğŸ” Automatically restarts if it stops
    environment:
      PMA_HOST: mysql # ğŸ“¦ phpMyAdmin image
      PMA_PORT: 3306 # ğŸ“¦ phpMyAdmin image
      PMA_USER: ${MYSQL_USER} # ğŸ“¦ phpMyAdmin image
      PMA_PASSWORD: ${MYSQL_PASSWORD} # ğŸ“¦ phpMyAdmin image
    ports:
      - "8082:80" # ğŸŒ Port mapping
    depends_on:
      - mysql # ğŸ”„ Depends on MySQL service
    networks:
      - infra-default-shared-net # ğŸŒ Network name
  
  # ğŸ³ Container for Redis
  redis:
    image: redis:7.2 # ğŸ“¦ Redis image
    container_name: infra-default-redis # ğŸ·ï¸ Container name
    env_file: .env # ğŸ“¦ Environment file
    restart: always # ğŸ” Automatically restarts if it stops
    ports:
      - "6379:6379" # ğŸŒ Port mapping
    volumes:
      - infra-default-redis_data:/data # ğŸ’¾ Volume for Redis data
    networks:
      - infra-default-shared-net # ğŸŒ Network name

  redisinsight:
    image: redis/redisinsight:latest # ğŸ“¦ Redis Insight image
    container_name: infra-default-redisinsight # ğŸ·ï¸ Container name
    #env_file: .env # ğŸ“¦ Environment file
    restart: always # ğŸ” Automatically restarts if it stops
    ports:
      - "8083:5540" # ğŸŒ Port mapping
    volumes:
      - infra-default-redisinsight_data:/usr/src/app/redisinsight/api/dist # ğŸ’¾ Volume for Redis Insight data
    user: "1000:1000" # ğŸ‘¤ User
    depends_on:
      - redis # ğŸ”„ Depends on Redis service
    networks:
      - infra-default-shared-net # ğŸŒ Network name

  rabbitmq:
    image: rabbitmq:management
    container_name: infra-default-rabbitmq # ğŸ·ï¸ Container name for rabbitmq
    restart: always # ğŸ” Automatically restarts if it stops
    env_file: .env
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_DEFAULT_USER}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_DEFAULT_PASS}
    ports:
      - "5672:5672"  # Porta para comunicaÃ§Ã£o AMQP
      - "15672:15672"  # Porta para o painel de gerenciamento
    volumes:
      - infra-default-rabbitmq_data:/var/lib/rabbitmq
    healthcheck:
      test: ["CMD-SHELL", "rabbitmqctl status"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - infra-default-shared-net

  # ğŸ³ Monitoring and Logging
  prometheus:
    image: prom/prometheus # ğŸ“¦ Prometheus image
    container_name: infra-default-prometheus # ğŸ·ï¸ Container name
    env_file: .env # ğŸ“¦ Environment file
    restart: always # ğŸ” Automatically restarts if it stops
    environment:
      - TZ=America/Lisbon # ğŸŒ Timezone
      - PROMETHEUS_CONFIG=./prometheus.yml # ğŸ”‘ Prometheus configuration file
    volumes:
      - infra-default-prometheus_data:/etc/prometheus/prometheus.yml # ğŸ’¾ Volume for Prometheus data
      - ./prometheus.yml:/etc/prometheus/prometheus.yml # ğŸ’¾ Volume for configuration
    ports:
      - "9090:9090" # ğŸŒ Port mapping
    networks:
      - infra-default-shared-net # ğŸŒ Network name

  grafana:
    image: grafana/grafana # ğŸ“¦ Grafana image
    container_name: infra-default-grafana # ğŸ·ï¸ Container name
    env_file: .env # ğŸ“¦ Environment file
    restart: always # ğŸ” Automatically restarts if it stops
    ports:
      - "3001:3000" # ğŸŒ Port mapping
    volumes:
      - infra-default-grafana-storage:/var/lib/grafana # ğŸ’¾ Volume for data persistence
      - ./grafana/provisioning:/etc/grafana/provisioning
      - ./grafana/dashboards:/var/lib/grafana/dashboards

    extra_hosts:
      - '172.17.0.1:host-gateway' # ğŸŒ Extra hosts
    environment:
      GF_SECURITY_ADMIN_USER: ${GF_SECURITY_ADMIN_USER} # ğŸ”‘ Grafana admin user
      GF_AUTH_ANONYMOUS_ENABLED: ${GF_AUTH_ANONYMOUS_ENABLED} # ğŸ”‘ Enable anonymous access
      GF_SECURITY_ADMIN_PASSWORD: ${GF_SECURITY_ADMIN_PASSWORD} # ğŸ”‘ Grafana admin password
      GF_AUTH_DISABLE_LOGIN_FORM: ${GF_AUTH_DISABLE_LOGIN_FORM} # ğŸ”‘ Disable login form
    networks:
      - infra-default-shared-net # ğŸŒ Network name

  cadvisor:
    image: gcr.io/cadvisor/cadvisor:latest # ğŸ“¦ cadvisor image
    container_name: infra-default-cadvisor # ğŸ·ï¸ Container name
    env_file: .env # ğŸ“¦ Environment file
    restart: always # ğŸ” Automatically restarts if it stops
    ports:
      - "8080:8080" # ğŸŒ Port mapping
    volumes:
      - /:/rootfs:ro # ğŸ’¾ Volume for root filesystem
      - /var/run:/var/run:ro # ğŸ’¾ Volume for run directory
      - /sys:/sys:ro # ğŸ’¾ Volume for sys directory
      - /var/lib/docker/:/var/lib/docker:ro # ğŸ’¾ Volume for Docker directory
    networks:
      - infra-default-shared-net # ğŸŒ Network name

  node-exporter:
    image: prom/node-exporter:latest # ğŸ“¦ Node Exporter image
    container_name: infra-default-node-exporter # ğŸ·ï¸ Container name
    env_file: .env # ğŸ“¦ Environment file
    restart: always # ğŸ” Automatically restarts if it stop
    ports:
      - "9100:9100" # ğŸŒ Port mapping
    networks:
      - infra-default-shared-net # ğŸŒ Network name
  
  # ğŸ” Exporter para PostgreSQL
  postgres-exporter:
    image: quay.io/prometheuscommunity/postgres-exporter # ğŸ“¦ PostgreSQL Exporter image
    container_name: infra-default-postgres-exporter # ğŸ·ï¸ Container name
    env_file: .env # ğŸ“¦ Environment file
    restart: always # ğŸ” Automatically restarts if it stops
    environment:
      DATA_SOURCE_NAME: "postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB}?sslmode=disable" # ğŸ”‘ PostgreSQL credentials
    ports:
      - "9187:9187" # ğŸŒ Port mapping
    networks:
      - infra-default-shared-net # ğŸŒ Network name
    depends_on:
      - postgres # ğŸ”„ Depends on PostgreSQL service

  # ğŸ›¢ï¸ Exporter para MySQL
  mysql-exporter:
    image: prom/mysqld-exporter:latest # ğŸ“¦ MySQL Exporter image
    container_name: infra-default-mysql-exporter # ğŸ·ï¸ Container name
    env_file: .env # ğŸ“¦ Environment file
    restart: always # ğŸ” Automatically restarts if it stops
    environment:
      DATA_SOURCE_NAME: ${MYSQL_USER}:${MYSQL_PASSWORD}@tcp(infra-defualt-mysql:3306)/ # ğŸ”‘ MySQL credentials
    ports:
      - "9104:9104" # ğŸŒ Port mapping
    networks:
      - infra-default-shared-net # ğŸŒ Network name 
    depends_on:
      - mysql # ğŸ”„ Depends on MySQL service
    command:
     - --mysqld.username=${MYSQL_USER}:$${MYSQL_PASSWORD} # ğŸ”‘ MySQL credentials
     - --mysqld.address=mysql:3306 # ğŸŒ Port mapping

  # ğŸ—„ï¸ Exporter para MongoDB
  mongodb-exporter:
    image: bitnami/mongodb-exporter:latest # ğŸ“¦ MongoDB Exporter image
    container_name: infra-default-mongodb-exporter # ğŸ·ï¸ Container name
    env_file: .env # ğŸ“¦ Environment file
    restart: always # ğŸ” Automatically restarts if it stops
    environment:
      MONGODB_URI: "mongodb://${MONGO_INITDB_ROOT_USERNAME}:${MONGO_INITDB_ROOT_PASSWORD}@mongo:27017" # ğŸ”‘ MongoDB credentials
    ports:
      - "9216:9216" # ğŸŒ Port mapping
    networks:
      - infra-default-shared-net # ğŸŒ Network name
    depends_on:
      - mongo # ğŸ”„ Depends on MongoDB service

  # ğŸš€ Exporter para Redis
  redis-exporter:
    image: oliver006/redis_exporter:latest # ğŸ“¦ Redis Exporter image
    container_name: infra-default-redis-exporter # ğŸ·ï¸ Container name
    env_file: .env # ğŸ“¦ Environment file
    restart: always # ğŸ” Automatically restarts if it stops
    environment:
      REDIS_ADDR: ${REDIS_ADDR} # ğŸ”‘ Redis credentials
    ports:
      - "9121:9121" # ğŸŒ Port mapping
    networks:
      - infra-default-shared-net # ğŸŒ Network name
    depends_on:
      - redis # ğŸ”„ Depends on Redis service

networks:
  infra-default-shared-net:
    name: infra-default-shared-net # ğŸŒ Network name
    driver: bridge # ğŸŒ Network driver

volumes:
  infra-default-sonarqube_data:
    name: infra-default-sonarqube_data
  infra-default-sonarqube_extensions:
    name: infra-default-sonarqube_extensions
  infra-default-sonarqube_logs:
    name: infra-default-sonarqube_logs
  infra-default-mongo_data:
    name: infra-default-mongo_data
  infra-default-postgres_data:
    name: infra-default-postgres_data
  infra-default-portainer_data:
    name: infra-default-portainer_data
  infra-default-pgadmin-data:
    name: infra-default-pgadmin-data
  infra-default-grafana-storage:
    name: infra-default-grafana-storage
  infra-default-mysql_data:
    name: infra-default-mysql_data
  infra-default-phpmyadmin_data:
    name: infra-default-phpmyadmin_data
  infra-default-redis_data:
    name: infra-default-redis_data
  infra-default-rabbitmq_data:
    name: infra-default-rabbitmq_data
  infra-default-redisinsight_data:
    name: infra-default-redisinsight_data